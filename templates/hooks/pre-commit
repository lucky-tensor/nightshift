#!/usr/bin/env node
/**
 * Nightshift Pre-Commit Hook
 * 
 * Enforces nag completion before allowing commits.
 * 
 * Installation:
 *   cp templates/hooks/pre-commit .git/hooks/pre-commit
 *   chmod +x .git/hooks/pre-commit
 * 
 * Bypass (human-supervised):
 *   NIGHTSHIFT_BYPASS=1 git commit -m "message"
 */

const fs = require('fs');
const path = require('path');

const NAG_STATUS_PATH = path.join(process.cwd(), '.nightshift', 'nag-status.json');

function main() {
    // Bypass check
    if (process.env.NIGHTSHIFT_BYPASS) {
        console.log('⚠️  Nightshift nag check bypassed');
        return 0;
    }

    // Skip if no nag status file
    if (!fs.existsSync(NAG_STATUS_PATH)) {
        return 0;
    }

    // Parse nag status
    let status;
    try {
        status = JSON.parse(fs.readFileSync(NAG_STATUS_PATH, 'utf-8'));
    } catch {
        return 0; // Allow commit if can't parse
    }

    // Find incomplete nags
    // Expects: { "nags": { "nag-name": "OK" | "NOK" } }
    const incomplete = Object.entries(status.nags || {})
        .filter(([_, status]) => status !== 'OK')
        .map(([name]) => name);

    if (incomplete.length === 0) {
        return 0;
    }

    // Block commit
    const box = (text, pad = 56) => '║  ' + text.padEnd(pad) + '  ║';

    console.error('');
    console.error('╔════════════════════════════════════════════════════════════╗');
    console.error('║            ❌ COMMIT BLOCKED - INCOMPLETE NAGS             ║');
    console.error('╠════════════════════════════════════════════════════════════╣');
    incomplete.forEach(name => console.error(box('• ' + name)));
    console.error('╠════════════════════════════════════════════════════════════╣');
    console.error(box('Complete quality checks, then run:'));
    console.error(box('  node .nightshift/hooks/nag-helper.js complete'));
    console.error(box(''));
    console.error(box('To bypass (human-supervised only):'));
    console.error(box('  NIGHTSHIFT_BYPASS=1 git commit ...'));
    console.error('╚════════════════════════════════════════════════════════════╝');
    console.error('');

    return 1;
}

process.exit(main());
